!function(){"use strict";$.Oda.App={version:"0.1",Websocket:null,WebsocketMessageType:{NEW_CONNECTION:"NEW_CONNECTION",CLOSE_CONNECTION:"CLOSE_CONNECTION",NEW_MESSAGE:"NEW_MESSAGE",WEBRTC_OFFER:"WEBRTC_OFFER",WEBRTC_ANSWER:"WEBRTC_ANSWER",PING_CALL:"PING_CALL",PING_ANSWER:"PING_ANSWER"},avatarId:0,startApp:function(){try{return $.Oda.Display.Polyfill.createHtmlElement({name:"kureha-chat-notificaiton",createdCallback:function(){var $elt=$(this),message=$elt.attr("message"),userCode=$elt.attr("userCode"),urlAvatar=$.Oda.Context.rest+"vendor/happykiller/oda/resources/api/avatar/"+userCode+"?mili"+$.Oda.Tooling.getMilise(),strHtml=$.Oda.Display.TemplateHtml.create({template:"kureha-chat-notif",scope:{message:message,userCode:userCode,urlAvatar:urlAvatar,time:$.Oda.Date.dateFormat(new Date,"yyyy-mm-dd hh:mi:ss")}});$elt.html(strHtml)}}),$.Oda.Display.Polyfill.createHtmlElement({name:"kureha-chat-sent",createdCallback:function(){var $elt=$(this),message=$elt.attr("message"),userCode=$elt.attr("userCode"),urlAvatar=$.Oda.Context.rest+"vendor/happykiller/oda/resources/api/avatar/"+userCode+"?mili"+$.Oda.Tooling.getMilise(),strHtml=$.Oda.Display.TemplateHtml.create({template:"kureha-chat-sent",scope:{message:message,userCode:userCode,urlAvatar:urlAvatar,time:$.Oda.Date.dateFormat(new Date,"yyyy-mm-dd hh:mi:ss")}});$elt.html(strHtml)}}),$.Oda.Display.Polyfill.createHtmlElement({name:"kureha-chat-receive",createdCallback:function(){var $elt=$(this),message=$elt.attr("message"),userCode=$elt.attr("userCode"),urlAvatar=$.Oda.Context.rest+"vendor/happykiller/oda/resources/api/avatar/"+userCode+"?mili"+$.Oda.Tooling.getMilise(),strHtml=$.Oda.Display.TemplateHtml.create({template:"kureha-chat-receive",scope:{message:message,userCode:userCode,urlAvatar:urlAvatar,time:$.Oda.Date.dateFormat(new Date,"yyyy-mm-dd hh:mi:ss")}});$elt.html(strHtml)}}),$.Oda.Router.addRoute("home",{path:"partials/home.html",title:"home.title",urls:["","home"],middleWares:["support","auth"]}),$.Oda.Router.startRooter(),this}catch(er){return $.Oda.Log.error("$.Oda.App.startApp: "+er.message),null}},Controller:{Home:{peerInitiator:null,peerReceiver:null,receiverId:0,presents:[],stream:null,start:function(){try{return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,$.Oda.App.Websocket=$.Oda.Websocket.connect($.Oda.Context.Websocket),$.Oda.App.Websocket.onConnect=function(e){$.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.NEW_CONNECTION,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id}),$.Oda.App.Controller.Home.pingAll()},$.Oda.App.Websocket.onMessage=function(e){switch($.Oda.Log.debug("New message => type:"+e.data.messageType+", from:"+e.data.userCode),e.data.messageType){case $.Oda.App.WebsocketMessageType.NEW_CONNECTION:$.Oda.App.Controller.Home.addPresent({userCode:e.data.userCode});break;case $.Oda.App.WebsocketMessageType.CLOSE_CONNECTION:$.Oda.App.Controller.Home.presentRemove({userCode:e.data.userCode});break;case $.Oda.App.WebsocketMessageType.NEW_MESSAGE:$("#chat").append('<kureha-chat-receive message="'+e.data.message+'" userCode="'+e.data.userCode+'"></kureha-chat-receive>');break;case $.Oda.App.WebsocketMessageType.PING_CALL:$.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.PING_ANSWER,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id,userFromCode:e.data.userCode,userFromId:e.data.userId});break;case $.Oda.App.WebsocketMessageType.PING_ANSWER:e.data.userFromCode===$.Oda.Session.code_user&&$.Oda.App.Controller.Home.addPresent({userCode:e.data.userCode});break;case $.Oda.App.WebsocketMessageType.WEBRTC_OFFER:$.Oda.App.Controller.Home.peerReceiver.signal(e.data.offer),$("#dialBt-"+e.data.userCode).html(""),$.Oda.App.Controller.Home.receiverId++;var strHtmlReceiver=$.Oda.Display.TemplateHtml.create({template:"tpl-receiver",scope:{id:$.Oda.App.Controller.Home.receiverId,userCode:e.data.userCode}});$("#receivers").append(strHtmlReceiver);break;case $.Oda.App.WebsocketMessageType.WEBRTC_ANSWER:$.Oda.App.Controller.Home.peerInitiator.signal(e.data.answer)}$("#chat").scrollTop($("#chat")[0].scrollHeight)},$.Oda.Scope.Gardian.add({id:"gardianMessage",listElt:["message"],function:function(e){$("#message").data("isOk")?$("#submit").btEnable():$("#submit").btDisable()}}),$.Oda.App.Controller.Home.startPeerReceiver(),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.start: "+er.message),null}},sent:function(){try{var message=$("#message").val();return $("#chat").append('<kureha-chat-sent message="'+message+'" userCode="'+$.Oda.Session.code_user+'"></kureha-chat-sent>'),$("#chat").scrollTop($("#chat")[0].scrollHeight),$.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.NEW_MESSAGE,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id,message:message}),$("#message").val(""),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.sent: "+er.message),null}},addPresent:function(p){try{$.Oda.App.Controller.Home.presents.push(p.userCode);var urlAvatar=$.Oda.Context.rest+"vendor/happykiller/oda/resources/api/avatar/"+p.userCode+"?mili"+$.Oda.Tooling.getMilise(),strHtml=$.Oda.Display.TemplateHtml.create({template:"tpl-present",scope:{userCode:p.userCode,urlAvatar:urlAvatar}});return $("#presents").append(strHtml),$("#chat").append('<kureha-chat-notificaiton message="New user: '+p.userCode+'" userCode="'+p.userCode+'"></kureha-chat-notificaiton>'),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.addPresent: "+er.message),null}},presentRemove:function(p){try{for(var index in $.Oda.App.Controller.Home.presents)$.Oda.App.Controller.Home.presents[index]===p.userCode&&$.Oda.App.Controller.Home.presents.splice(index,1);return $("#present-"+p.userCode).remove(),$("#receiver-"+p.userCode).remove(),$("#chat").append('<kureha-chat-notificaiton message="User left: '+p.userCode+'" userCode="'+p.userCode+'"></kureha-chat-notificaiton>'),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.presentRemove: "+er.message),null}},startPeerReceiver:function(){try{return navigator.getUserMedia({video:!0,audio:{facingMode:"user"}},function(stream){$.Oda.App.Controller.Home.stream=stream;var video=document.querySelector("#emitter-video");video.srcObject=$.Oda.App.Controller.Home.stream,video.volume=0,video.play(),$.Oda.App.Controller.Home.peerReceiver=new SimplePeer({initiator:!1,stream:$.Oda.App.Controller.Home.stream,trickle:!0}),$.Oda.App.Controller.Home.bindEvents($.Oda.App.Controller.Home.peerReceiver),$.Oda.App.Controller.Home.peerReceiver.on("signal",function(data){"answer"===data.type&&$.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.WEBRTC_ANSWER,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id,answer:data})})},function(){}),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.startPeerReceiver: "+er.message),null}},call:function(p){try{$.Oda.App.Controller.Home.peerInitiator=new SimplePeer({initiator:!0,stream:$.Oda.App.Controller.Home.stream,trickle:!1}),$.Oda.App.Controller.Home.bindEvents($.Oda.App.Controller.Home.peerInitiator),$("#dialBt-"+p.userCode).html(""),$.Oda.App.Controller.Home.receiverId++;var strHtmlReceiver=$.Oda.Display.TemplateHtml.create({template:"tpl-receiver",scope:{id:$.Oda.App.Controller.Home.receiverId,userCode:p.userCode}});return $("#receivers").append(strHtmlReceiver),$.Oda.App.Controller.Home.peerInitiator.on("signal",function(data){"offer"===data.type&&$.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.WEBRTC_OFFER,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id,userTargetCode:p.userCode,offer:data})}),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.call: "+er.message),null}},pingAll:function(){try{return $.Oda.App.Websocket.send({messageType:$.Oda.App.WebsocketMessageType.PING_CALL,userCode:$.Oda.Session.code_user,userId:$.Oda.Session.id}),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.pingAll: "+er.message),null}},bindEvents:function(p){try{return p.on("error",function(data){console.log("error peer",data)}),p.on("stream",function(stream){var strHtmlReceiver=$.Oda.Display.TemplateHtml.create({template:"tpl-receiver-video",scope:{id:$.Oda.App.Controller.Home.receiverId}});$("#div-receiver-video-"+$.Oda.App.Controller.Home.receiverId).html(strHtmlReceiver);var video=document.querySelector("#receiver-video-"+$.Oda.App.Controller.Home.receiverId);video.srcObject=stream,video.volume=0,video.play()}),this}catch(er){return $.Oda.Log.error("$.Oda.App.Controller.Home.bindEvents: "+er.message),null}}}}},function(){$.Oda.Event.addListener({name:"oda-fully-loaded",callback:function(e){var listDepends=[{name:"depends",ordered:!1,list:[{elt:$.Oda.Context.host+"/templates/templates.html",type:"html",target:function(data){$("body").append(data)}}]}];$.Oda.Loader.load({depends:listDepends,functionFeedback:function(data){$.Oda.Log.debug("depends loading success."),$.Oda.App.startApp()}})}})}()}();